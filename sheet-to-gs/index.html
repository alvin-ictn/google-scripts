<!DOCTYPE html>
<html>
  <head>
    <title>Google Sheets Data</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Winky+Sans:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Winky Sans", sans-serif;
      }
    </style>
    <script>
      const speciesWar = {
        goldfish:
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/goldfish.webp",
        "dung bettles":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/dung%20beetles.webp",
        hamster:
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/hamster.webp",
        mantis:
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/mantis.webp",
        "surf clams":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/surf%20clams.webp",
      };

      const weekly = {
        "Wishing Week":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/wishing_banner_2.webp",
        "Lottery Week":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/lottery_banner.webp",
        "Offering Week":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/offering_banner.webp",
      };
      // Function to modify sheetData before displaying it
      function toTwoDigits(num) {
        return num.toString().padStart(2, "0");
      }
      let month = 1,
        startIndex = -1,
        endIndex = -1;

      function getMonthRangeIndex(data, targetMonth) {
        let startIndex = -1,
          endIndex = -1;

        for (let i = 0; i < data.length; i++) {
          let range = data[i].trim();
          if (!range) continue; // Skip empty values

          let dates = range.split(" - ");
          let startMonth = dates[0].split("/")[0]; // Extract start month
          let endMonth = dates[1].split("/")[0]; // Extract end month

          console.log("I", i, startMonth, endMonth);

          // Find the first occurrence of the target month
          if (
            (startMonth === targetMonth && startIndex === -1) ||
            (endMonth === targetMonth && startIndex === -1)
          ) {
            startIndex = i;
          }

          // Find the last occurrence of the target month
          if (startMonth === targetMonth || endMonth === targetMonth) {
            endIndex = i;
          }
        }
        return { startIndex, endIndex };
      }

      const filterData = (headers, bodyData, start, end) => {
        let fHead = headers.slice(start, end + 1);
        let fBody = bodyData.map((bData) => bData.slice(start, end + 1));
        return {
          hd: fHead,
          bd: fBody,
        };
      };

      const generateHTMLElem = (headD = null, bodyD = null) => {
        if(!headD || !bodyD) {
            return {hElem: null, bElem: null}
        }

        let tHead = headD?.map((h) => `<th>${h}</th>`).join("")
        let tBody = bodyD
          .map(
            (row, rowIdx) =>
              `<tr>${row
                .map((cell, cellIdx) => {
                  return `<td>${
                    Object.keys(weekly).includes(cell)
                      ? `<img src="${weekly[cell]}" alt="${cell}-${rowIdx}-${cellIdx}"/>`
                      : cell
                  }</td>`;
                })
                .join("")}</tr>`
          )
          "<tr>" + headD?.map((h) => `<th>${h}</th>`).join("") + "</tr>";

        let hElem = "<tr>" +tHead+ "</tr>";
        let bElem = tBody?.join("")

        return {
            hElem,
            bElem
        }
      };

      function modifySheetData(data) {
        let parsedData = JSON.parse(data);
        // Example 1: Remove the first row (headers)
        let headers = parsedData[0]; // Keep headers for the table
        let bodyData = parsedData.slice(1); // Remove first row

        return { headers, bodyData }; // Return modified data
      }



      function renderTable() {
          let data = <?= JSON.stringify(sheetData) ?>; // Get data from Apps Script
        let { headers, bodyData } = modifySheetData(data); // Modify data
        let thead = document.getElementById("tableHead");
        let tbody = document.getElementById("tableBody");

        document.getElementById("next").addEventListener("click", function () {
          month = month < 12 ? month + 1 : month;
          const monthIdx = getMonthRangeIndex(headers, toTwoDigits(month));
          startIndex = monthIdx.startIndex;
          endIndex = monthIdx.endIndex;
          let { hd, bd } = filterData(
            headers,
            bodyData,
            monthIdx.startIndex,
            monthIdx.endIndex + 1
          );

          const {hElem,bElem} = generateHTMLElem(hd, bd)

          thead.innerHTML = hElem;
          tbody.innerHTML = bElem;
        });

        document.getElementById("prev").addEventListener("click", function () {
          month = month > 1 ? month - 1 : month;
          const monthIdx = getMonthRangeIndex(headers, toTwoDigits(month));
          startIndex = monthIdx.startIndex;
          endIndex = monthIdx.endIndex;
          console.log(month, startIndex, endIndex, monthIdx);
          let { hd, bd } = filterData(
            headers,
            bodyData,
            monthIdx.startIndex,
            monthIdx.endIndex + 1
          );

          const {hElem,bElem} = generateHTMLElem(hd, bd)

          thead.innerHTML = hElem;
          tbody.innerHTML = bElem;
        });
        // document.querySelector("#currentMonth").html = `${}`
        console.log("\n\nbodyDaya", bodyData);

        // Get table elements

        // Render table headers
        thead.innerHTML =
          "<tr>" + headers.map((h) => `<th>${h}</th>`).join("") + "</tr>";

        // Render table body
        tbody.innerHTML = bodyData
          .map(
            (row, rowIdx) =>
              `<tr>${row
                .map((cell, cellIdx) => {
                  return `<td>${
                    Object.keys(weekly).includes(cell)
                      ? `<img src="${weekly[cell]}" alt="${cell}-${rowIdx}-${cellIdx}"/>`
                      : cell
                  }</td>`;
                })
                .join("")}</tr>`
          )
          .join("");
      }
    </script>
  </head>

  <body onload="renderTable()">
    <h1>Super Snail SEA Calendar</h1>
    <button id="prev">Prev</button>
    <div id="currentMonth"></div>
    <button id="next">Next</button>
    <table border="1">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </body>
</html>
