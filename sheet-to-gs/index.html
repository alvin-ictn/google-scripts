<!DOCTYPE html>
<html>
  <head>
    <title>Google Sheets Data</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Winky+Sans:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Winky Sans", sans-serif;
      }
    </style>
    <script>
      // Function to modify sheetData before displaying it
      function toTwoDigits(num) {
        return num.toString().padStart(2, "0");
      }
      let month = 1,
        startIndex = -1,
        endIndex = -1;

      function getMonthRangeIndex(data, targetMonth) {
        let startIndex = -1,
          endIndex = -1;

        for (let i = 0; i < data.length; i++) {
          let range = data[i].trim();
          if (!range) continue; // Skip empty values

          let dates = range.split(" - ");
          let startMonth = dates[0].split("/")[0]; // Extract start month
          let endMonth = dates[1].split("/")[0]; // Extract end month

          console.log("I", i, startMonth, endMonth);

          // Find the first occurrence of the target month
          if (
            (startMonth === targetMonth && startIndex === -1) ||
            (endMonth === targetMonth && startIndex === -1)
          ) {
            startIndex = i;
          }

          // Find the last occurrence of the target month
          if (startMonth === targetMonth || endMonth === targetMonth) {
            endIndex = i;
          }
        }
        return { startIndex, endIndex };
      }

      const filterData = (headers, bodyData, start, end) => {
        let fHead = headers.slice(start, end + 1);
        let fBody = bodyData.map((bData) => bData.slice(start, end + 1));
        return {
          hd: fHead,
          bd: fBody,
        };
      };

      function modifySheetData(data) {
        let parsedData = JSON.parse(data);
        // Example 1: Remove the first row (headers)
        let headers = parsedData[0]; // Keep headers for the table
        let bodyData = parsedData.slice(1); // Remove first row

        return { headers, bodyData }; // Return modified data
      }

      function renderTable() {
        let data = <?= JSON.stringify(sheetData) ?>; // Get data from Apps Script
        let { headers, bodyData } = modifySheetData(data); // Modify data
        let thead = document.getElementById("tableHead");
        let tbody = document.getElementById("tableBody");

        document.getElementById("next").addEventListener("click", function () {
          month = month < 12 ? month + 1 : month;
          const monthIdx = getMonthRangeIndex(headers, toTwoDigits(month));
          startIndex = monthIdx.startIndex;
          endIndex = monthIdx.endIndex;
          let { hd, bd } = filterData(
            headers,
            bodyData,
            monthIdx.startIndex,
            monthIdx.endIndex + 1
          );

          thead.innerHTML =
            "<tr>" + hd.map((h) => `<th>${h}</th>`).join("") + "</tr>";

          tbody.innerHTML = bd
            .map(
              (row) =>
                `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`
            )
            .join("");
        });

        document.getElementById("prev").addEventListener("click", function () {
          month = month > 1 ? month - 1 : month;
          const monthIdx = getMonthRangeIndex(headers, toTwoDigits(month));
          startIndex = monthIdx.startIndex;
          endIndex = monthIdx.endIndex;
          console.log(month, startIndex, endIndex, monthIdx)
          let { hd, bd } = filterData(
            headers,
            bodyData,
            monthIdx.startIndex,
            monthIdx.endIndex + 1
          );

          thead.innerHTML =
            "<tr>" + hd.map((h) => `<th>${h}</th>`).join("") + "</tr>";

          // Render table body
          tbody.innerHTML = bd
            .map(
              (row) =>
                `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`
            )
            .join("");
        });
        // document.querySelector("#currentMonth").html = `${}`
        console.log("\n\nbodyDaya", bodyData);

        // Get table elements

        // Render table headers
        thead.innerHTML =
          "<tr>" + headers.map((h) => `<th>${h}</th>`).join("") + "</tr>";

        // Render table body
        tbody.innerHTML = bodyData
          .map(
            (row) =>
              `<tr>${row.map((cell) => `<td>${cell}</td>`).join("")}</tr>`
          )
          .join("");
      }
    </script>
  </head>

  <body onload="renderTable()">
    <h1>Super Snail SEA Calendar</h1>
    <button id="prev">Prev</button>
    <div id="currentMonth"></div>
    <button id="next">Next</button>
    <table border="1">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </body>
</html>
