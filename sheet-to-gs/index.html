<!DOCTYPE html>
<html>
  <head>
    <title>Google Sheets Data</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Winky+Sans:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      body {
        font-family: "Winky Sans", sans-serif;
      }
    </style>
    <script>
      const reporter =
        "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/reporter.webp";
      const speciesWar = {
        goldfish:
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/goldfish.webp",
        "dung beetles":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/dung%20beetles.webp",
        hamster:
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/hamster.webp",
        mantis:
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/mantis.webp",
        "surf clams":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/surf%20clams.webp",
      };

      const weekly = {
        "Wishing Week":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/wishing_banner_2.webp",
        "Lottery Week":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/lottery_banner.webp",
        "Offering Week":
          "https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/offering_banner.webp",
      };
      // Function to modify sheetData before displaying it
      function toTwoDigits(num) {
        return num.toString().padStart(2, "0");
      }
      let month = 1,
        startIndex = -1,
        endIndex = -1,
        monthMode = "week",
        baseHeaders = null,
        baseBody = null,
        baseKeyEvent = null,
        shiftNum = 0;

      function getMonthRangeIndex(data, targetMonth, mode = "full") {
        let startIndex = -1,
          endIndex = -1;

        if (mode === "week") {
          startIndex = (parseInt(targetMonth) - 1) * 4;
          endIndex = (parseInt(targetMonth) - 1) * 4 + 3;
        } else {
          for (let i = 0; i < data.length; i++) {
            let range = data[i].trim();
            if (!range) continue; // Skip empty values

            let dates = range.split(" - ");
            let startMonth = dates[0].split("/")[0]; // Extract start month
            let endMonth = dates[1].split("/")[0]; // Extract end month

            // Find the first occurrence of the target month
            if (
              (startMonth === targetMonth && startIndex === -1) ||
              (endMonth === targetMonth && startIndex === -1)
            ) {
              startIndex = i - 1;
            }

            // Find the last occurrence of the target month
            if (startMonth === targetMonth || endMonth === targetMonth) {
              endIndex = i - 1;
            }
          }
        }

        return { startIndex, endIndex };
      }

      const filterData = (headers, bodyData, start, end) => {
        if (headers[0] !== "") {
          headers.unshift("");
        }

        let fHead = headers.slice(start, end + 1);
        let fBody = bodyData.map((bData) => bData.slice(start, end));

        if (fHead[0] !== "") {
          fHead[0] = "";
        }

        return {
          hd: fHead,
          bd: fBody,
        };
      };

      const generateHTMLElem = (headD = null, bodyD = null, key = null) => {
        if (!headD || !bodyD || !key) {
          return { hElem: null, bElem: null };
        }
        const headDLength = headD.length - 1;
        let width = (window.innerWidth - 132) / headDLength;

        let tHead = headD
          ?.map(
            (h, hIndex) =>
              `<th class="border ${
                hIndex === 0 ? "min-w-[100px]" : `min-w-[${width}px]`
              }">${h}</th>`
          )
          .join("");

        let realBody = key.map((header, index) => [header, ...bodyD[index]]);
        let columnRowspan = Array(realBody[0].length).fill(1); // Track rowspan for each column

        let tBody = realBody.map((row, rowIdx) => {
          return `<tr>${row
            .map((cell, cellIdx) => {
              //   console.log(cellIdx === 0 ? cell : "NON");
              //   let combinedCell = rowIdx === 2 ? cell
              console.log(rowIdx, cellIdx, cell);
              return `<td class="border p-1" ${
                rowIdx === 2 && `rowspan=${realBody.length - 2}`
              }>
                ${
                  Object.keys(weekly).includes(cell)
                    ? `<img class="weekly-banner" src="${weekly[cell]}" alt="${cell}-${rowIdx}-${cellIdx}"/>`
                    : Object.keys(speciesWar)
                        .map((r) => r.toLocaleLowerCase())
                        .includes(cell.toLocaleLowerCase())
                    ? `<img class="weekly-banner relative bottom-[-4px]" src="${
                        speciesWar[cell.toLocaleLowerCase()]
                      }" alt="${cell}-${rowIdx}-${cellIdx}"/>`
                    : cell.includes("|")
                    ? `<ul class="list-disc ml-4">${cell
                        .split("|")
                        .map((li) => `<li>${li}</li>`)
                        .join("")}</ul>`
                    : `<p class="${
                        cellIdx === 0 && "text-lg font-semibold"
                      }">${cell}</p>`
                }</td>`;
            })
            .join("")}</tr>`;
        });
        "<tr>" + headD?.map((h) => `<th>${h}</th>`).join("") + "</tr>";

        let hElem = "<tr>" + tHead + "</tr>";
        let bElem = tBody?.join("");

        return {
          hElem,
          bElem,
        };
      };

      function modifySheetData(data) {
        console.log(typeof data);
        let parsedData = typeof data === "object" ? data : JSON.parse(data);
        // Example 1: Remove the first row (headers)
        let headers = parsedData[0]; // Keep headers for the table
        let rawBody = parsedData.slice(1); // Remove first row
        let keyEvent = rawBody.map((row) => row[0]); // First element from each row
        let bodyData = rawBody.map((row) => row.slice(1)); // Everything except the first element

        return { headers, bodyData, keyEvent }; // Return modified data
      }

      function renderTable() {
        //   let data = <?= JSON.stringify(sheetData) ?>; // Get data from Apps Script
        const data = [
          [
            "",
            "12/30 - 01/05",
            "01/06 - 01/12",
            "01/13 - 01/19",
            "01/20 - 01/26",
            "01/27 - 02/02",
            "02/03 - 02/09",
            "02/10 - 02/16",
            "02/17 - 02/23",
            "02/24 - 03/02",
            "03/03 - 03/09",
            "03/10 - 03/16",
            "03/17 - 03/23",
            "03/24 - 03/30",
            "03/31 - 04/06",
            "04/07 - 04/13",
            "04/14 - 04/20",
            "04/21 - 04/27",
            "04/28 - 05/04",
            "05/05 - 05/11",
            "05/12 - 05/18",
            "05/19 - 05/25",
            "05/26 - 06/01",
            "06/02 - 06/08",
            "06/09 - 06/15",
            "06/16 - 06/22",
            "06/23 - 06/29",
            "06/30 - 07/06",
            "07/07 - 07/13",
            "07/14 - 07/20",
            "07/21 - 07/27",
            "07/28 - 08/03",
            "08/04 - 08/10",
            "08/11 - 08/17",
            "08/18 - 08/24",
            "08/25 - 08/31",
            "09/01 - 09/07",
            "09/08 - 09/14",
            "09/15 - 09/21",
            "09/22 - 09/28",
          ],
          [
            "Weekly Event",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "Wishing Week",
            "Offering Week",
            "Lottery Week",
            "",
          ],
          [
            "Species War",
            "Hamster",
            "Mantis",
            "Dung Beetles",
            "Goldfish",
            "",
            "Hamster",
            "Mantis",
            "Dung Beetles",
            "Goldfish",
            "Surf Clams",
            "Hamster",
            "",
            "",
            "",
            "",
            "Hamster",
            "Mantis",
            "Dung Beetles",
            "Goldfish",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
          ],
          [
            "Game Utilities",
            "Partner Album",
            "Avatar Group\nOpen Chest in Batch",
            "Dung Beetle Chronicle Ranking",
            "Species Map Upgrade",
            " Hellenic Domain",
            "Control Panel",
            "No updates",
            "Species war F21-F24",
            "Unlock Partner (Baby Eater)",
            "Unlock Special Hitman(Leader of the Gourmets Guild, Dead Knight, Duchy Emissary)",
            "Tiny World",
            "",
            "",
            "",
            "",
            "Clone War",
            "Protomon Update                                 The 3rd Lottery Machine                                      Furnace Upgrade",
            "New version of Organs&Gene Evolution",
            "nothing yet",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
          ],
          [
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "Explore\n（Time Rift lvl 1-240）",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
          ],
          [
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "Mini game:Master Decoder",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
            "",
          ],
        ];
        data[3] = data[3].map((cell, col) =>
          col === 0
            ? cell
            : [
                cell,
                ...data
                  .slice(4)
                  .map((row) => row[col])
                  .filter(Boolean),
              ].join(" | ")
        );

        // Keep only the first 4 rows
        data.length = 4;
        let { headers, bodyData, keyEvent } = modifySheetData(data); // Modify data

        baseHeaders = headers;
        baseBody = bodyData;
        baseKeyEvent = keyEvent;
        console.log("");

        const monthIdx = getMonthRangeIndex(
          baseHeaders,
          toTwoDigits(month),
          monthMode
        );

        startIndex = monthIdx.startIndex;
        endIndex = monthIdx.endIndex;

        let { hd, bd } = filterData(
          baseHeaders,
          baseBody,
          monthIdx.startIndex,
          monthIdx.endIndex + 1
        );

        // document.querySelector("#currentMonth").html = `${}`
        const { hElem, bElem } = generateHTMLElem(hd, bd, keyEvent);

        thead.innerHTML = hElem;
        tbody.innerHTML = bElem;
      }
    </script>
  </head>

  <body onload="renderTable()">
    <div class="flex w-[300px] justify-between">
      <button
        id="prev"
        class="transition-transform duration-300 hover:scale-110 cursor-pointer w-[100px]"
      >
        <img
          src="https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/prev_2.webp"
        />
      </button>
      <button
        id="next"
        class="transition-transform duration-300 hover:scale-110 cursor-pointer w-[100px]"
      >
        <img
          src="https://zbkwzidcrqhucyhodzkc.supabase.co/storage/v1/object/public/super-snail/calendar/next_2.webp"
        />
      </button>
    </div>
    <div class="tooltip-container relative">
      <div class="relative">
        <label>Calendar show</label>
        <select
          id="weekSelect"
          class="border border-[#6e5e55] rounded-md p-2 cursor-pointer"
          onmouseover="showTooltip()"
          onmouseout="hideTooltip()"
        >
          <option value="week">4 Weeks</option>
          <option value="full">Full Week</option>
        </select>
      </div>
      <div class="flex gap-4" id="shift-container">
        <p>Shift</p>
        <div class="flex gap-2">
          <button
            class="px-2 border border-[#6e5e55] bg-[#d4b28b] rounded-md cursor-pointer"
            id="shift-left"
          >
            ❰
          </button>
          <button
            class="px-2 border border-[#6e5e55] bg-[#d4b28b] rounded-md cursor-pointer"
            id="shift-right"
          >
            ❱
          </button>
        </div>
      </div>
      <div
        id="tooltip"
        class="absolute invisible p-2 bg-[#d4b28b] top-[5px] left-[210px] rounded-md border-[2px] border-[#6e5e55]"
      >
        <ul>
          <li>
            <span><b>Full Week</b> - will show all week in single month</span>
          </li>
          <li>
            <span><b>4 Weeks</b> - will show only 4 weeks in single month</span>
          </li>
        </ul>
      </div>
    </div>
    <div class="relative flex flex-col">
      <!-- Image and Title Container -->
      <div class="relative flex flex-col items-center mt-[30px]">
        <img class="relative" id="reporter" />
        <div
          class="border-2 border-[#6e5e55] bg-[#d4b28b] rounded-md w-fit py-2 px-4 z-5 text-center relative top-[-5px]"
        >
          <h1 class="text-4xl">Super Snail SEA Calendar</h1>
        </div>
      </div>

      <!-- Table Below Image and Title -->
      <!-- Table Below Image and Title -->
      <div class="p-4 w-full">
        <table class="border border-1 mt-[20px] w-full">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </body>
  <footer>
    <script>
      let thead = document.getElementById("tableHead");
      let tbody = document.getElementById("tableBody");
      let shiftContainer = document.getElementById("shift-container");
      let shiftLeft = document.getElementById("shift-left");
      let shiftRight = document.getElementById("shift-right");

      if (monthMode === "full") {
        shiftContainer.style.display = "none";
      } else {
        shiftContainer.style.display = "flex"; // or "flex" if they are flex items
      }

      document
        .getElementById("weekSelect")
        .addEventListener("change", function () {
          if (this.value === "full") {
            shiftContainer.style.display = "none";
          } else {
            shiftContainer.style.display = "flex"; // or "flex" if they are flex items
          }
          monthMode = this.value;
          const monthIdx = getMonthRangeIndex(
            baseHeaders,
            toTwoDigits(month),
            this.value
          );

          startIndex = monthIdx.startIndex;
          endIndex = monthIdx.endIndex;
          console.log("START", monthIdx);
          let { hd, bd } = filterData(
            baseHeaders,
            baseBody,
            monthIdx.startIndex,
            monthIdx.endIndex + 1
          );

          const { hElem, bElem } = generateHTMLElem(hd, bd, baseKeyEvent);

          thead.innerHTML = hElem;
          tbody.innerHTML = bElem;
        });

      function showTooltip() {
        document.getElementById("tooltip").style.visibility = "visible";
        document.getElementById("tooltip").style.opacity = "1";
      }

      function hideTooltip() {
        document.getElementById("tooltip").style.visibility = "hidden";
        document.getElementById("tooltip").style.opacity = "0";
      }

      document.getElementById("reporter").src = reporter;

      shiftLeft.addEventListener("click", function () {
        shiftNum -= 1;
        const monthIdx = getMonthRangeIndex(
          baseHeaders,
          toTwoDigits(month),
          monthMode
        );

        startIndex = monthIdx.startIndex;
        endIndex = monthIdx.endIndex;

        let { hd, bd } = filterData(
          baseHeaders,
          baseBody,
          monthIdx.startIndex + shiftNum,
          monthIdx.endIndex + 1 + shiftNum
        );

        const { hElem, bElem } = generateHTMLElem(hd, bd, baseKeyEvent);

        thead.innerHTML = hElem;
        tbody.innerHTML = bElem;
      });
      shiftRight.addEventListener("click", function () {
        shiftNum += 1;
        const monthIdx = getMonthRangeIndex(
          baseHeaders,
          toTwoDigits(month),
          monthMode
        );

        startIndex = monthIdx.startIndex;
        endIndex = monthIdx.endIndex;

        let { hd, bd } = filterData(
          baseHeaders,
          baseBody,
          monthIdx.startIndex + shiftNum,
          monthIdx.endIndex + 1 + shiftNum
        );

        const { hElem, bElem } = generateHTMLElem(hd, bd, baseKeyEvent);

        thead.innerHTML = hElem;
        tbody.innerHTML = bElem;
      });
      document.getElementById("next").addEventListener("click", function () {
        month = month < 12 ? month + 1 : month;
        const monthIdx = getMonthRangeIndex(
          baseHeaders,
          toTwoDigits(month),
          monthMode
        );

        startIndex = monthIdx.startIndex;
        endIndex = monthIdx.endIndex;

        let { hd, bd } = filterData(
          baseHeaders,
          baseBody,
          monthIdx.startIndex,
          monthIdx.endIndex + 1
        );

        const { hElem, bElem } = generateHTMLElem(hd, bd, baseKeyEvent);

        thead.innerHTML = hElem;
        tbody.innerHTML = bElem;
      });

      document.getElementById("prev").addEventListener("click", function () {
        month = month > 1 ? month - 1 : month;
        const monthIdx = getMonthRangeIndex(
          baseHeaders,
          toTwoDigits(month),
          monthMode
        );
        startIndex = monthIdx.startIndex;
        endIndex = monthIdx.endIndex;

        let { hd, bd } = filterData(
          baseHeaders,
          baseBody,
          monthIdx.startIndex,
          monthIdx.endIndex + 1
        );

        const { hElem, bElem } = generateHTMLElem(hd, bd, baseKeyEvent);

        thead.innerHTML = hElem;
        tbody.innerHTML = bElem;
      });
    </script>
  </footer>
</html>
